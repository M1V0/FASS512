---
title: "5. Live Data Wrangling Walkthrough"
author: "Matthew Ivory"
format: html
---

## Set up environment

```{r}
library(tidyverse)
# anything else goes here
```

## Import Data

Read in key datafiles

```{r}
data_raw <- read_csv("swiss_crime_2022.csv")
```

Check out the data

```{r}
head(data_raw)
colnames(data_raw)
```

## Tidying data to minimum required

What do we need to keep if we are wanting to visualise the differences in type of crime convicted in the Swiss Adult population according to age?

```{r}
data <- data_raw |> 
  select(crime, crime_type, contains("age"))
```

## How do I condense down all the specific crimes into one value?

```{r}
data_tidy <- data |>
  group_by(crime_type) |> 
  mutate(age18_19 = sum(age18_19),
         age20_24 = sum(age20_24),
         age25_29 = sum(age25_29),
         age30_34 = sum(age30_34),
         age35_39 = sum(age35_39),
         age40_44 = sum(age40_44),
         age45_49 = sum(age45_49),
         age50_59 = sum(age50_59),
         age60_69 = sum(age60_69),
         age70plus = sum(age70plus)
         ) |> 
  select(-crime) |> 
  distinct()

# factor the group data
data_tidy <- data_tidy |> 
  mutate(crime_type = factor(crime_type, levels = c("Moderate violence (threat of violence)", 
                                                    "Moderate violence (exercise of violence evt. threat of violence)",
                                                    "Severe violence (exercise of violence)")))
```

## pivot so it's ready for plotting

```{r}
data_tidy_long <- data_tidy |> 
  pivot_longer(cols = age18_19:age70plus, 
               names_to = "age_group", 
               values_to = "convictions")

```
## Plotting

```{r}
data_tidy_long |> 
  filter(crime_type == "Severe violence (exercise of violence)") |> 
  ggplot(aes(age_group, convictions)) +
  geom_col()

#try colour first, and then go to fill
data_tidy_long |> 
  ggplot(aes(age_group, convictions, fill = crime_type)) +
  geom_col(position = "dodge")
```

What can we see in the dataset (as well as the x-axis) that indicates this is a misleadingly organised dataset?

The age ranges are not consistent - so the above plot is misleading, just like the examples in week 4.

```{r}
data_tidy_ages <- data_tidy |> mutate(
  age20_29 = sum(age20_24, age25_29),
  age30_39 = sum(age30_34, age35_39),
  age40_49 = sum(age40_44, age45_49),
  .before = age50_59
) |> 
  select(-c(age20_24, age25_29, age30_34, age35_39, age40_44, age45_49))

data_tidy_ages_long <- data_tidy_ages |> 
  pivot_longer(cols = age18_19:age70plus, 
               names_to = "age_group", 
               values_to = "convictions") 

data_tidy_ages_long |> 
  ggplot(aes(age_group, convictions, fill = crime_type)) +
  geom_col(position = "dodge")
```

```{r}
data_tidy_ages_long_sum <- data_tidy_ages_long |> 
  group_by(age_group) |> 
  summarise(total = sum(convictions))

data_tidy_ages_long_percent <- data_tidy_ages_long |> 
  left_join(data_tidy_ages_long_sum, by = join_by(age_group)) |> 
  mutate(percentage = convictions/total*100)

##sanity check
#data_tidy_ages_long_percent |> 
#  filter(age_group == "age18_19") |> 
#  pull(percentage) |> sum()
```

```{r}
data_tidy_ages_long_percent |> 
  ggplot(aes(age_group, percentage, colour = crime_type)) +
  geom_col(position = "dodge")
```

What inferences can we draw from this? What else could we explore?